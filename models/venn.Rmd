---
title: "model_simulations"
author: "MH Tessler"
date: "10/25/2020"
output: html_document
---

```{r setup, include=FALSE}
library(rwebppl)
library(tidyverse)
library(ggVennDiagram)
library(jsonlite)
library(ggplot2)
library(gridExtra)
set.seed(20201027)
```


Helper functions

```{r}
# get_samples_from_df = function(df){
#   data.frame(df) %>%
#     pivot_longer(-prob, names_to = "key", values_to = "val") %>%
#     group_by(key) %>%
#     summarize(prob = sum(val * prob)
#               ) %>%
#     rwebppl::get_samples(., num_samples = 1000)
# }
# 
# get_samples_from_df = function(df, field1){
#   data.frame(df[[field1]]) %>%
#     pivot_longer(-probs, names_to = "key", values_to = "val") %>%
#     group_by(key) %>%
#     summarize(prob = sum(val * probs),
#               src = field1
#               ) %>%
#     rwebppl::get_samples(., num_samples = 1000)
# }

get_samples_from_df = function(df, field1, field2){
  data.frame(df[[field1]][[field2]]) %>%
    pivot_longer(-probs, names_to = "key", values_to = "val") %>%
    group_by(key) %>%
    summarize(prob = sum(val * probs),
              utterance = field1,
              src = field2
              ) %>%
    rwebppl::get_samples(., num_samples = 1000)
}

genes <- paste("sample",1:100000,sep="")

get_venn_samples <- function(df_samples){
  
  make_venn_sample <- function(region, i){
    # print(i)
    samp = genes[i]
    A = ifelse(str_detect(region, "A"), samp, NA)
    B = ifelse(str_detect(region, "B"), samp, NA)
    C = ifelse(str_detect(region, "C"), samp, NA)
     return(data.frame(A = A, B = B, C = C))
  }
  x <- imap(df_samples, make_venn_sample) %>%
    bind_rows(.)

  list(
    A = x$A[!is.na(x$A)],
    B = x$B[!is.na(x$B)],
    C = x$C[!is.na(x$C)]
  )
}

format_sentence = function(sentence){
  split_sentences = str_split(sentence, "/")[[1]]
  n_sentences = length(split_sentences)
  formatted_sentences = c()
  for (sent in split_sentences){
    sentence_parts = str_split(sent, ";")[[1]]
    q1 = ifelse(sentence_parts[1] == "None", "No",
          ifelse(sentence_parts[1] == "Some not", "Some",
                      sentence_parts[1]))
    q2 = ifelse(sentence_parts[1] == "Some not", "not ", "")
    formatted_sentence = paste(
        q1, " ",
        paste(sentence_parts[2], "s", sep = ""),
        " are ",
        q2,
        paste(sentence_parts[3], "s", sep = ""),
        sep = ""
      )
    formatted_sentences <- c(formatted_sentences, formatted_sentence)
  }
  paste(formatted_sentences, collapse = "\n")
}

make_venn_digram <- function(df, utt){
  ggVennDiagram(get_venn_samples(
    df %>% filter(utterance == utt) %>% pull(key)
  ), label = NULL, color = 'black') +
    ggtitle(format_sentence(utt)) + 
    scale_fill_gradient(low = "white", high = "grey10",
                        limits = c(0, 1000),
                        breaks = c(0, 500, 1000),
                        labels = c(0, 0.5, 1),
                        name = "Probability")+
    # guides(fill = F)+
    theme(plot.title = element_text(hjust = 0.5))
}
```

Run Webppl Model

```{r}
# syllogism <- data.frame(
#   p1 = c("A", "B"),
#   p2 = c("B", "C"),
#   quantifier = c("some", "some")
# ) 

wp.rs <- webppl(
  program_file = "venn-r.wppl"#,
  # data = syllogism,
  # data_var = "syllogism"
)

# get_venn_samples(get_samples_from_df(wp.rs) %>% pull(key)) %>% ggVennDiagram(.)

# get_samples_from_df

wp.rs.samples <- bind_rows(
  map(names(wp.rs), function(s){
    map(names(wp.rs[[s]]), function(k){
      return(get_samples_from_df(wp.rs, s, k))
    })
  })
)

# wp.rs.samples <- bind_rows(
#   get_samples_from_df(wp.rs, "All;A;B", "literal"),
#   get_samples_from_df(wp.rs, "All;A;B", "pragmatic"),
#   # get_samples_from_df(wp.rs, "All;B;A"),
#   get_samples_from_df(wp.rs, "Some;A;B", "literal"),
#   get_samples_from_df(wp.rs, "Some;A;B", "pragmatic"),
#   # get_samples_from_df(wp.rs, "Some;B;A"),
#   get_samples_from_df(wp.rs, "Some not;A;B", "literal"),
#   get_samples_from_df(wp.rs, "Some not;A;B", "pragmatic"),
#   # get_samples_from_df(wp.rs, "Some not;B;A"),
#   get_samples_from_df(wp.rs, "None;A;B", "literal"),#,
#   get_samples_from_df(wp.rs, "None;A;B", "pragmatic")#,
#   # get_samples_from_df(wp.rs, "None;B;A")
# )
```

Literal interpretations

```{r}
all_plots <- map(unique(wp.rs.samples$utterance), 
                 function(x){ make_venn_digram (
                   wp.rs.samples %>% filter(src == "literal"), x 
                   ) } )


legend <- cowplot::get_legend(
  # create some space to the left of the legend
  all_plots[[1]] + theme(legend.box.margin = margin(0, 0, 0, 12))
)

all_plots[[1]] + ggtitle("")
ggsave("../publications/topics/figs/venn_AA1_exp.pdf", width = 3, height = 2.5)

all_plots[[3]] + ggtitle("")
ggsave("../publications/topics/figs/venn_EI1_exp.pdf", width = 3, height = 2.5)
# plot_grid(prow, legend, rel_widths = c(3, .4))
cowplot::plot_grid(
  cowplot::plot_grid(
    all_plots[[1]] + theme(legend.position="none"),
    all_plots[[2]] + theme(legend.position="none"),
    all_plots[[3]] + theme(legend.position="none"), nrow = 1),
  legend,
  rel_widths = c(3, .4),
  # cowplot::plot_grid(plotlist = all_plots_prag_head, nrow = 1)+ 
  #   theme(plot.margin = unit(c(1,0,0,0), "lines")),
  nrow = 1, #labels = c("literal", "pragmatic state", "pragmatic qud"),# "pragmatic head"),
  label_size = 12,
  label_x = 0, #label_y = 0,
  hjust = -0.15#, #vjust = -0.2
)

ggsave("../publications/topics/figs/venn_literal_AA1_AI1_EI1_exp.pdf", width = 9, height = 2.5)

```

```{r}

all_plots_prag_state <- map(unique(wp.rs.samples$utterance), 
                 function(x){ make_venn_digram (
                   wp.rs.samples %>% filter(src == "pragmatic_state"), x 
                   ) } )

all_plots_prag_AC <- map(unique(wp.rs.samples$utterance), 
                 function(x){ make_venn_digram (
                   wp.rs.samples %>% filter(src == "pragmatic_AC"), x 
                   ) } )

all_plots_prag_head <- map(unique(wp.rs.samples$utterance), 
                 function(x){ make_venn_digram (
                   wp.rs.samples %>% filter(src == "pragmatic_head"), x 
                   ) } )

cowplot::plot_grid(
  cowplot::plot_grid(plotlist = all_plots, nrow = 1) + 
    theme(plot.margin = unit(c(1.25,0,1,0), "lines")),
  cowplot::plot_grid(plotlist = all_plots_prag_state, nrow = 1)+ 
    theme(plot.margin = unit(c(1,0,0,0), "lines")),
  cowplot::plot_grid(plotlist = all_plots_prag_AC, nrow = 1)+ 
    theme(plot.margin = unit(c(1,0,0,0), "lines")),
  # cowplot::plot_grid(plotlist = all_plots_prag_head, nrow = 1)+ 
  #   theme(plot.margin = unit(c(1,0,0,0), "lines")),
  nrow = 3, labels = c("literal", "pragmatic state", "pragmatic qud"),# "pragmatic head"),
  label_size = 12,
  label_x = 0, #label_y = 0,
  hjust = -0.15#, #vjust = -0.2
)

# ggsave("../publications/topics/figs/venn_premise1_lit_prag.pdf", width = 8, height = 4.5)

```


```{r}
wp.rs.samples %>%
  filter(src %in% c("pragmatic_state", "pragmatic_head")) %>%
  group_by(src, utterance, key) %>%
  count() %>%
  pivot_wider(names_from = key, values_from = n) %>% View()

```


```{r}
# wp.rs.samples <- bind_rows(
#   get_samples_from_df(wp.rs, "sequential"),
#   get_samples_from_df(wp.rs, "pragmatic"),
#   get_samples_from_df(wp.rs, "literal")
# )

# Make Venn Diagram

plot1 <- make_venn_digram(wp.rs.samples, "literal")
plot2 <- make_venn_digram(wp.rs.samples, "pragmatic")
plot3 <- make_venn_digram(wp.rs.samples, "sequential")

grid.arrange(plot1, plot2, plot3, ncol=3)


```


```{r}
data.frame(wp.rs$sequential) %>%
  rowwise() %>%
  mutate(AC = support.AC || support.ABC) %>%
  ungroup() %>%
  group_by(AC) %>%
  count(sum(probs))
  # summarize(sum(!AB))

data.frame(wp.rs$sequential) %>%
  group_by(support.AB, support.ABC) %>%
  count(sum(probs))
```


# Speaker model

```{r}
wp.rs <- webppl(
  program_file = "venn-r.wppl"#,
  # data = syllogism,
  # data_var = "syllogism"
)

marginalize_speaker_dist = function(joint_dist, venn, qud){
  return (bind_rows(
  data.frame(wp.rs[[venn]][[qud]]) %>%
    group_by(support.1) %>%
    summarize(marginalProb = sum(probs),
              premise_num = '1') %>%
    ungroup() %>%
    rename(premise = support.1),
  data.frame(wp.rs[[venn]][[qud]]) %>%
    group_by(support.2) %>%
    summarize(marginalProb = sum(probs),
              premise_num = '2') %>%
    ungroup() %>%
    rename(premise = support.2)
  ) %>%
  mutate(
    venn = venn,
    qud = qud
  ))
}


venns = names(wp.rs)
quds = names(wp.rs[[venns[1]]])

wp.rs.s.marginals <- bind_rows(
  map(venns, function(venn){
    map(quds, function(qud){
      return(marginalize_speaker_dist(wp.rs, venn, qud))
    })
  })
)
```


Speaker marginals on premises

```{r}
wp.rs.s.marginals %>%
  rowwise() %>%
  mutate(quantifier = str_split(premise, ";")[[1]][1],
         premise_num = factor(premise_num, levels = c("1", "2"),
                              labels = c("As are Bs", "Bs are Cs")),
         qud = factor(qud, levels = c("stateQud", "acQud"),
                      labels = c("State QUD", "Conclusion QUD")),
         quantifier = factor(quantifier, levels = c("All", "Some",
                                                    "Some not", "No"))) %>%
  ggplot(., aes( fill = quantifier, y = marginalProb,
                               x = venn, group = quantifier))+
  geom_col(position = position_dodge(), color = 'black')+
  facet_grid(
    qud ~ premise_num
  )+
  viridis::scale_fill_viridis(discrete = T)+
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)
  )
```

