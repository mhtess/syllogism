---
title: "Experiments 1, 2: Basic data analysis"
author: "mht"
date: "September 22, 2014"
output: html_document
---

# 1. RTs (time to complete each item)


```{r prep, echo=FALSE}
library(ggplot2)
library(reshape2)
library(plyr)
library(stringr)
library(gridExtra)
library(bootstrap)

theta <- function(x,xdata,na.rm=T) {mean(xdata[x],na.rm=na.rm)}
ci.low <- function(x,na.rm=T) {
  mean(x,na.rm=na.rm) - quantile(bootstrap(1:length(x),1000,theta,x,na.rm=na.rm)$thetastar,.025,na.rm=na.rm)}
ci.high <- function(x,na.rm=T) {
  quantile(bootstrap(1:length(x),1000,theta,x,na.rm=na.rm)$thetastar,.975,na.rm=na.rm) - mean(x,na.rm=na.rm)}

agr.ci <- function(x){
  agr = aggregate(value ~ domain + condition + syll + variable + experiment, data=x, FUN=mean)
  agr$CILow = aggregate(value ~ domain + condition + syll + variable + experiment, data=x, FUN=ci.low)$value
  agr$CIHigh = aggregate(value ~ domain + condition + syll + variable + experiment, data=x, FUN=ci.high)$value
  agr$YMin = agr$value - agr$CILow
  agr$YMax = agr$value + agr$CIHigh
  return(agr)
}

agr.ci.collapsed <- function(x){
  agr = aggregate(value ~ domain + syll + variable + experiment, data=x, FUN=mean)
  agr$CILow = aggregate(value ~ domain + syll + variable + experiment, data=x, FUN=ci.low)$value
  agr$CIHigh = aggregate(value ~ domain + syll + variable + experiment, data=x, FUN=ci.high)$value
  agr$YMin = agr$value - agr$CILow
  agr$YMax = agr$value + agr$CIHigh
  return(agr)
}
```

```{r RTs1, echo=FALSE}

fpath = '/Users/mht/Documents/research/syllogism/data/03syllogism_reasoning/'
fpath2 = '/Users/mht/Documents/research/syllogism/data/04syllogism_reasoning/'


df<-read.csv((paste(fpath,'syllbelief-exp-mturk_all_n250.csv',sep="")))
df$experiment <- factor(1)
df2<-read.csv((paste(fpath2,'syllbelief-exp2-mturk.csv',sep="")))
df2$condition<-paste(df2$condition,'2',sep='.')
df2$experiment <- factor(2)

df.c <- rbind(df,df2)

exp1sylls<-levels(df$syll)
exp2sylls<-levels(df2$syll)
resp_labels<-c("Q_A","Q_E","Q_I","Q_O")

map_radio_to_continuous <- function(rad,cts){50+(2*rad-1)*(cts/2)}


#for (i in 1:length(df2$subj)){
#  if (df2[i,]$condition=='radio'){
#    df2[i,]$Q_A <- map_radio_to_continuous(df2[i,]$radio_A,df2[i,]$Q_A)
#    df2[i,]$Q_E <- map_radio_to_continuous(df2[i,]$radio_E,df2[i,]$Q_E)
#    df2[i,]$Q_I <- map_radio_to_continuous(df2[i,]$radio_I,df2[i,]$Q_I)
#    df2[i,]$Q_O <- map_radio_to_continuous(df2[i,]$radio_O,df2[i,]$Q_O)
#  }
#}

ggplot(df.c, aes(x=(rt/1000)))+
  geom_histogram(binwidth=3,
                 aes(y=(..count..)/tapply(..count..,..PANEL..,sum)[..PANEL..]))+
  theme_bw()+
  facet_wrap(~experiment,scales='fixed',nrow=1)+
  ggtitle("Experiments 1 & 2 RTs, binsize = 3s")+
  xlab('time (sec)')+
  ylab('proportion of items')

```

*mean RT for Exp 1 = `r mean(df$rt/1000)`*

*mean RT for Exp 2 = `r mean(df2$rt/1000)`*

*standard deviation for Exp 1 = `r sqrt(var(df$rt/1000))`*

*standard deviation for Exp 2 = `r sqrt(var(df2$rt/1000))`*

Removing items greater than 2 standard deviations above the mean RT.

For experiment 1: `r (mean(df$rt)+2*sqrt(var(df$rt)))/1000`

For experiment 2: `r (mean(df2$rt)+2*sqrt(var(df2$rt)))/1000`

```{r RTs2, echo=FALSE}

df<-subset(df,rt<mean(df$rt)+2*sqrt(var(df$rt)))
df2<-subset(df2,rt<mean(df2$rt)+2*sqrt(var(df2$rt)))

df.c <- rbind(df,df2)
df.c$condition<-factor(df.c$condition,levels=c('slide','radio','radio.2'))

for (i in 1:length(df.c$subj)){
  if (substring(df.c[i,]$condition,1,5)=='radio'){
    df.c[i,]$Q_A <- map_radio_to_continuous(df.c[i,]$radio_A,df.c[i,]$Q_A)
    df.c[i,]$Q_E <- map_radio_to_continuous(df.c[i,]$radio_E,df.c[i,]$Q_E)
    df.c[i,]$Q_I <- map_radio_to_continuous(df.c[i,]$radio_I,df.c[i,]$Q_I)
    df.c[i,]$Q_O <- map_radio_to_continuous(df.c[i,]$radio_O,df.c[i,]$Q_O)
  }
}

ggplot(df.c, aes(x=(rt/1000),fill=condition))+
  geom_histogram(binwidth=3,
      aes(y=(..count..)/tapply(..count..,..PANEL..,sum)[..PANEL..]))+
  theme_bw()+
 facet_wrap(~condition,scales='fixed')+
  ggtitle("Experiment RTs (sans outliers), binsize = 3s")+
  xlab('time (sec)')+
  ylab('proportion of items')
```

# 2. Slider value distributions

n _ slider for experiment 1 (sans outliers): `r length(subset(df,condition=='slide')$subj)/4`

n _ radio for experiment 1 (sans outliers): `r length(subset(df,condition=='radio')$subj)/4`

n _ radio for experiment 2 (sans outliers): `r length(subset(df2,condition=='radio')$subj)/4`

## Raw slider value distributions

```{r raw-slide, echo=FALSE}
ggplot(melt(df.c[3:7]), aes(x=value,fill=condition))+
  geom_histogram(binwidth=5,aes(y=..count../sum(..count..)))+
  facet_wrap(~condition)+
  theme_bw()+
  ggtitle('raw slider values')+
  xlab('slider value, binsize = 5')+
  ylab('proportion of responses')+
  guides(fill=FALSE)


df.c$sum<-rowSums(df.c[,resp_labels])
df.c$max<-apply(df.c[,resp_labels],1,max)
```


## Normalized slider value distribution

```{r}
df_norm = ddply(df.c, .(domain,condition,syll,experiment), function(x) {
  resp = x[,resp_labels]
  resp / rowSums(resp)
})

#df_norm = ddply(df, .(domain,syll), function(x) {
#  resp = x[,resp_labels]
#  resp / rowSums(resp)
#})

ggplot(melt(df_norm), aes(x=value,fill=condition))+
  geom_histogram(binwidth=0.02,
      aes(y=(..count..)/tapply(..count..,..PANEL..,sum)[..PANEL..]))+
  facet_wrap(~condition)+
  theme_bw()+
  ggtitle('normalized slider values')+
  xlab('slider value, binsize = 0.02')+
  ylab('proportion of responses')+
  guides(fill=FALSE)
```

## Raw *sum* distributions

```{r rawsum, echo=FALSE}
ggplot(melt(df.c[c('condition','sum')]), aes(x=value,fill=condition))+
  geom_histogram(binwidth=5,
      aes(y=(..count..)/tapply(..count..,..PANEL..,sum)[..PANEL..]))+
  facet_wrap(~condition)+
  theme_bw()+
  ggtitle('Sum of slider values')+
  xlab('slider value, binsize = 5')+
  ylab('number of responses')+
  guides(fill=FALSE)
```

## Raw *max* distributions

```{r rawmax}
ggplot(melt(df.c[c('condition','max')]), aes(x=value,fill=condition))+
  geom_histogram(binwidth=1,
      aes(y=(..count..)/tapply(..count..,..PANEL..,sum)[..PANEL..]))+
  facet_wrap(~condition)+
  theme_bw()+
  ggtitle('max raw slider values')+
  xlab('slider value, binsize = 1')+
  ylab('number of responses')+
  guides(fill=FALSE)
```

# 3. Syllogistic reasoning data

## Experiment 1

```{r, fig.width=16, fig.height=8, echo=FALSE}
exp_domains = c('_ crackers that have lots of flavor are soggy',
                '_ knives that cut well are sharp',
                '_ lightbulbs that are hot are on',
                '_ strawberries that are warm are in the freezer')

quantifiers = c("All of the","None of the","Some of the","Some of the...not")

ci_bs <- agr.ci(melt(df_norm))
ci_bs$domain<-factor(ci_bs$domain,labels=exp_domains)
ci_bs$conclusion<-factor(ci_bs$variable,labels=quantifiers)

ggplot(subset(ci_bs,experiment==1), 
       aes(x=conclusion, y=value, fill=condition)) + 
    geom_bar(position=position_dodge(.6), 
             width = .6,
             stat='identity')+
    geom_errorbar(aes(ymin=YMin,ymax=YMax),
                  width=0.3,
                position=position_dodge(.6))+
  xlab("conclusion")+
  ylab("endorsement")+
  facet_grid(domain~syll)+
  ggtitle("experiment 1 data")+
  theme_bw()+
  xlab('')+
  theme(axis.text.x=element_text(
    angle=90,size=13,hjust=1,vjust=.5,colour='gray50'),
    strip.text.x = element_text(),
    strip.text.y = element_text(size=13,angle=0))

ci_bs_col <- agr.ci.collapsed(melt(df_norm))
ci_bs_col$domain<-factor(ci_bs_col$domain,labels=exp_domains)
ci_bs_col$conclusion<-factor(ci_bs_col$variable,labels=quantifiers)

mean_cast <-dcast(subset(ci_bs,experiment==1)
                  [,c('syll','conclusion','condition','value','domain')], 
                  value.var='value',...~condition)
```

### Compare (radio + slider) value to just radio buttons

#### Experiment 1: [normalized]

```{r radiocomp1_norm, echo=FALSE}

df_rad<-ddply(subset(df,condition=='radio'), .(syll,domain), summarize,
      all=mean(radio_A),
      some=mean(radio_I),
      none=mean(radio_E),
      notall=mean(radio_O))

df_rad_norm<-data.frame(t(apply(df_rad[,3:6],1,function(x)(x/sum(x)))))
df_rad_norm$syll <- df_rad$syll
df_rad_norm$domain <- df_rad$domain

df_rad.m<- melt(df_rad_norm, id.vars=c('syll','domain'),value.name='justrad')

ci_bs <- subset(agr.ci(melt(df_norm)),condition=='radio')
ci_bs$variable<-factor(ci_bs$variable, labels= c('all','none','some','notall'))

radios<-merge(df_rad.m,ci_bs[,c('domain','syll','variable','value')])

ggplot(radios,aes(x=value,y=justrad,color=variable))+
  geom_point(size=2.5)+
  theme_bw()+
  xlim(0,0.6)+
  ylim(0,0.6)

```

#### Experiment 1 [unnormalized]

```{r radiocomp1_unnorm, echo=FALSE}

df_rad<-ddply(subset(df,condition=='radio'), .(syll,domain), summarize,
      all=mean(radio_A),
      some=mean(radio_I),
      none=mean(radio_E),
      notall=mean(radio_O))


ci_unnorm <- agr.ci(melt(subset(df,condition=='radio'), id.vars=c('syll','domain','experiment','condition')))
ci_bs$variable<-factor(ci_bs$variable, labels= c('all','none','some','notall'))

radios<-merge(df_rad.m,ci_bs[,c('domain','syll','variable','value')])

ggplot(radios,aes(x=value,y=justrad,color=variable))+
  geom_point(size=2.5)+
  theme_bw()+
  xlim(0,0.6)+
  ylim(0,0.6)

```

### An aside to check iPython notebook on Bayesian analysis

```{r tfbt, echo=FALSE}
data1<-read.csv(file='/Users/mht/Documents/research/syllogism/data/03syllogism_reasoning/syllbelief-exp-means_collapsed_sansOutliers.csv')[2:7]
data1.m <- melt(data1)
# renaming for merge
data1.m$variable<-factor(data1.m$variable, labels=c('Q_A','Q_E','Q_I','Q_O'))
data1.m$domain<-factor(data1.m$domain,labels=exp_domains) # rename domains for merge
names(data1.m)[4]<-'data1.m' # rename "value" col for merge

## correspondence with slider DM
ci_bs.sub<-subset(ci_bs,(condition=='slide' & experiment==1)) #subset by DM
ci_bs.sub<-ci_bs.sub[c('domain','syll','variable','value')] # subset relavent cols

data1.cibs<-merge(data1.m,ci_bs.sub)

print(with(data1.cibs,cor(value,data1.m)))

## correspondence with radio DM
ci_bs.sub<-subset(ci_bs,(condition=='radio' & experiment==1)) #subset by DM
ci_bs.sub<-ci_bs.sub[c('domain','syll','variable','value')] # subset relavent cols

data1.cibs<-merge(data1.m,ci_bs.sub)

print(with(data1.cibs,cor(value,data1.m)))

## all of this suggests we are dealing with the same DATA as before

# am I computing correlation between data and models correctly?
model.dir<-'/Users/mht/Documents/research/syllogism/models/modeldata/LATTICE_4_tfbt/'
domains<- c('cracker', 'knife', 'lightbulb', 'strawberry')
syllogisms = c('AO2', 'EA3', 'IE1', 'OA1')
n_obj = 4
corrs = c()
for (n_obj in 4:10){
  model = data.frame()
  for (d in domains){
    model.all<-read.csv(paste(model.dir,d,'/00/csv/lis_N0_M0_tfbt',
                   d,'_qud1figFull_AIEOc4CAEP1_n',n_obj,
                   '_base0.00_s100k_alphQ1_alphR1_bsmean.csv',sep=''))[c(1,6:9)]
    model.sub<-model.all[model.all$X..syll%in%syllogisms,]
    model.sub$domain <- d
    model<-rbind(model, model.sub)
  }
  #rename for merging
  names(model)<-c('syll','All','None','Some','Some_not','domain')
  dm.m<-merge(melt(model,value.name='model'),melt(data1,value.name='data'))
  corrs<-append(corrs,with(dm.m,cor(data,model)))
}



```
### An aside to examine similiarity of dependent measures

Correlation between mean responses for radio button + slider vs. just slider is `r with(mean_cast,cor(radio,slide))`

```{r radioslidescatter, echo=FALSE}

ggplot(mean_cast,aes(x=radio,y=slide,color=conclusion))+
  geom_point(size=4)+
  geom_abline(intercept=0,slope=1)+
  theme_bw()+
  xlim(0,0.7)+
  ylim(0,0.7)

```

### Experiment 1, collapsed across dependent measures

```{r, echo=FALSE, fig.width=16, fig.height=8}
ggplot(subset(ci_bs_col,experiment==1), 
       aes(x=conclusion, y=value, fill=conclusion)) + 
    geom_bar(position=position_dodge(.6), 
             width = .6,
             stat='identity')+
    geom_errorbar(aes(ymin=YMin,ymax=YMax),
                  width=0.3,
                position=position_dodge(.6))+
  xlab("conclusion")+
  ylab("endorsement")+
  facet_grid(domain~syll)+
  ggtitle("experiment 1 data --- collapsed across dependent measure")+
  theme_bw()+
  xlab('')+
  guides(fill=F)+
  theme(axis.text.x=element_text(
    angle=90,size=13,hjust=1,vjust=.5,colour='gray50'),
    strip.text.x = element_text(),
    strip.text.y = element_text(size=13,angle=0))
```

## Experiment 2

```{r, echo=FALSE, fig.width=16, fig.height=8}
ggplot(subset(ci_bs_col,experiment==2), 
       aes(x=conclusion, y=value, fill=conclusion)) + 
    geom_bar(position=position_dodge(.6), 
             width = .6,
             stat='identity')+
    geom_errorbar(aes(ymin=YMin,ymax=YMax),
                  width=0.3,
                position=position_dodge(.6))+
  xlab("conclusion")+
  ylab("endorsement")+
  facet_grid(domain~syll)+
  ggtitle("experiment 2 data")+
  theme_bw()+
  xlab('')+
  guides(fill=F)+
  theme(axis.text.x=element_text(
    angle=90,size=13,hjust=1,vjust=.5,colour='gray50'),
    strip.text.x = element_text(),
    strip.text.y = element_text(size=13,angle=0))
```

# Fin 

Write collapsed means to csv

collapsed_wide<-dcast(col_bs[,c("domain","syll","conclusion","value")], value.var='value',...~conclusion)
write.csv(collapsed_wide,file='syllogism/data/03syllogism_reasoning/syllbelief-exp-means_collapsed_sansOutliers.csv')


exp_domains = c('lightbulb','strawberry','cracker','knife')

fpath<-'/Users/mht/Documents/research/syllogism/data/03syllogism_prior_psychjs/'
m.df<-read.csv(paste(fpath,'3modeldata_oed_plausibility_depth0iidArgStr_emprArgStr_emprCLonly.csv',sep=''))[-1]
prag.df<-read.csv(paste(fpath,'prgmtcOED_oed_frequency_depth1_alpha5iidArgStr_emprArgStr_emprCLonly.csv',sep=''))[-1]
prag.df<-subset(prag.df,model=='prgmtc_empr')

m.df<-subset(m.df,X..syll%in%levels(ci_bs$syll))
prag.df<-subset(prag.df,X..syll%in%levels(ci_bs$syll))

m.df<-rbind(m.df,prag.df)


mm.df<-melt(m.df,id.vars=c('model','X..syll'))
mm.df$response<-as.character(mm.df$variable)
mm.df$domain<-str_split_fixed(mm.df$response, "[.]", 2)[,1]
mm.df$conclusion<-str_split_fixed(mm.df$response, "[.]", 2)[,2]
mm.df<-subset(mm.df,domain%in%exp_domains)
mm.df$domain<-factor(mm.df$domain,levels = exp_domains)


ggplot(data=mm.df,aes(x=conclusion,y=value))+
  geom_bar(aes(fill=model),stat='identity',position='dodge')+
  facet_grid(domain~X..syll)+
  scale_alpha_manual(values=c(1,0.5))+
  #scale_x_discrete(labels=c("some C are A","some C are not A"))+
  theme_bw()+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=.5,colour='gray50'))


### model data correlations


flds<-c('syll','value','domain','conclusion')

d1.df<-subset(ci_bs,condition=='slide')[,flds]
names(d1.df)[2]<-'value.slide'
d2.df<-subset(ci_bs,condition=='radio')[,flds]
names(d2.df)[2]<-'value.radio'

m1.df<-subset(mm.df,model=='argstr_iid')
m2.df<-subset(mm.df,model=='argstr_empr')
m3.df<-subset(mm.df,model=='clonly_empr')
m4.df<-subset(mm.df,model=='prgmtc_empr')

m1.df$conclusion<-factor(m1.df$conclusion,labels=quantifiers)
m2.df$conclusion<-factor(m2.df$conclusion,labels=quantifiers)
m3.df$conclusion<-factor(m3.df$conclusion,labels=quantifiers)
m4.df$conclusion<-factor(m4.df$conclusion,labels=quantifiers)

names(m1.df)[2]<-'syll'
names(m2.df)[2]<-'syll'
names(m3.df)[2]<-'syll'
names(m4.df)[2]<-'syll'

m1.df<-m1.df[,flds]
m2.df<-m2.df[,flds]
m3.df<-m3.df[,flds]
m4.df<-m4.df[,flds]

names(m1.df)[2]<-'value.argstr_iid'
names(m2.df)[2]<-'value.argstr_empr'
names(m3.df)[2]<-'value.clonly_empr'
names(m4.df)[2]<-'value.prgmtc_empr'

mega.df<-join_all(list(d1.df,d2.df,m1.df,m2.df,m3.df,m4.df),by=c('domain','syll','conclusion'))
cor(mega.df[,c("value.slide",'value.radio','value.argstr_iid','value.argstr_empr','value.clonly_empr','value.prgmtc_empr')])

#mega.df<-join_all(list(d1.df,d2.df,m1.df,m2.df,m3.df),by=c('domain','syll','conclusion'))
#cor(mega.df[,c("value.slide",'value.radio','value.argstr_iid','value.argstr_empr','value.clonly_empr')])




### pairwise ggplots

makePairs <- function(data) 
{
  grid <- expand.grid(x = 1:ncol(data), y = 1:ncol(data))
  grid <- subset(grid, x != y)
  all <- do.call("rbind", lapply(1:nrow(grid), function(i) {
    xcol <- grid[i, "x"]
    ycol <- grid[i, "y"]
    data.frame(xvar = names(data)[ycol], yvar = names(data)[xcol], 
               x = data[, xcol], y = data[, ycol], data)
  }))
  all$xvar <- factor(all$xvar, levels = names(data))
  all$yvar <- factor(all$yvar, levels = names(data))
  densities <- do.call("rbind", lapply(1:ncol(data), function(i) {
    data.frame(xvar = names(data)[i], yvar = names(data)[i], x = data[, i])
  }))
  list(all=all, densities=densities)
}
 
# expand iris data frame for pairs plot
gg1 = makePairs(mega.df[,c("value.slide",'value.radio','value.argstr_iid','value.argstr_empr','value.clonly_empr')])
 
# new data frame mega iris
mega_gg1 = data.frame(gg1$all, colorvar=rep(mega.df$conclusion, length=nrow(gg1$all)))
 
# pairs plot
ggplot(mega_gg1, aes_string(x = "x", y = "y")) + 
  facet_grid(xvar ~ yvar, scales = "free") + 
  geom_point(aes(colour=colorvar), na.rm = TRUE, alpha=0.8,size=3) + 
  stat_density(aes(x = x, y = ..scaled.. * diff(range(x)) + min(x)), 
               data = gg1$densities, position = "identity", 
               colour = "grey20", geom = "line")+
  theme_bw()+
  theme(strip.text = element_text(size = 20, angle = 0))



### reasoning with priors vs. data

ggplot(mega.df, aes(x=value.argstr_empr, y=value.radio, color=conclusion))+
  geom_point(size=5)+
  theme_bw()

